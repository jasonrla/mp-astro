const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["_astro/checkoutStore.BjY-Dy3Q.js","_astro/index.Be8AcK8B.js"])))=>i.map(i=>d[i]);
import{e as S,j as l,f as P,k as O,i as k,g as N,c as j,t as F}from"./checkoutStore.BjY-Dy3Q.js";import{r as m,R as B}from"./index.Be8AcK8B.js";const C=S("payment"),v=S(null),_=S(null),g=S(null),V=()=>{C.value="payment",v.value=null,_.value=null,g.value=null},W="modulepreload",X=function(n){return"/"+n},D={},T=function(d,a,i){let f=Promise.resolve();if(a&&a.length>0){let t=function(o){return Promise.all(o.map(e=>Promise.resolve(e).then(r=>({status:"fulfilled",value:r}),r=>({status:"rejected",reason:r}))))};document.getElementsByTagName("link");const c=document.querySelector("meta[property=csp-nonce]"),u=c?.nonce||c?.getAttribute("nonce");f=t(a.map(o=>{if(o=X(o),o in D)return;D[o]=!0;const e=o.endsWith(".css"),r=e?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${o}"]${r}`))return;const p=document.createElement("link");if(p.rel=e?"stylesheet":W,e||(p.as="script"),p.crossOrigin="",p.href=o,u&&p.setAttribute("nonce",u),document.head.appendChild(p),e)return new Promise((x,h)=>{p.addEventListener("load",x),p.addEventListener("error",()=>h(new Error(`Unable to preload CSS for ${o}`)))})}))}function s(t){const c=new Event("vite:preloadError",{cancelable:!0});if(c.payload=t,window.dispatchEvent(c),!c.defaultPrevented)throw t}return f.then(t=>{for(const c of t||[])c.status==="rejected"&&s(c.reason);return d().catch(s)})};var b={},R;function Z(){if(R)return b;R=1,Object.defineProperty(b,"__esModule",{value:!0}),b.loadMercadoPago=void 0;const n="https://sdk.mercadopago.com/js/v2",d=/^https:\/\/sdk\.mercadopago\.com\/js\/v2\/?(\?.*)?$/,a="MercadoPago has already been initialized in your window, please remove the duplicate import",i="MercadoPago.js not available",f="Failed to load MercadoPago.js",s=()=>{for(var o=document.querySelectorAll(`script[src^="${n}"`),e=0;e<o.length;e++){var r=o[e];if(d.test(r.src))return r}return null},t=()=>{const o=document.createElement("script");o.src=n;const e=document.head||document.body;if(!e)throw new Error("Expected document.body or document.head not to be null. MercadoPago requires a <body> or a <head> element, please add on your project.");return e.appendChild(o),o};let c=null;const u=()=>(c!==null||(c=new Promise((o,e)=>{if(typeof window>"u"){o(null);return}if(window.MercadoPago){console.warn(a),o(window.MercadoPago);return}try{let r=s();r?console.warn(a):r||(r=t()),r.addEventListener("load",()=>{window.MercadoPago?o(window.MercadoPago):e(new Error(i))}),r.addEventListener("error",()=>{e(new Error(f))})}catch(r){e(r);return}})),c);return b.loadMercadoPago=u,b}var J=Z(),Y=function(n,d,a,i){function f(s){return s instanceof a?s:new a(function(t){t(s)})}return new(a||(a=Promise))(function(s,t){function c(e){try{o(i.next(e))}catch(r){t(r)}}function u(e){try{o(i.throw(e))}catch(r){t(r)}}function o(e){e.done?s(e.value):f(e.value).then(c,u)}o((i=i.apply(n,d||[])).next())})};class w{static getInstance(){return Y(this,void 0,void 0,function*(){if(this.publicKey)return this.loadedInstanceMercadoPago||(yield J.loadMercadoPago(),this.loadedInstanceMercadoPago=!0),this.instanceMercadoPago||(this.instanceMercadoPago=new window.MercadoPago(this.publicKey,this.options)),this.instanceMercadoPago;console.error("Expected the PUBLIC_KEY to render the MercadoPago SDK React")})}}w.publicKey=null;w.options={};w.instanceMercadoPago=void 0;w.loadedInstanceMercadoPago=!1;function H(n,d){return Object.keys(n).length===Object.keys(d).length&&Object.keys(n).every(i=>Object.prototype.hasOwnProperty.call(d,i)&&n[i]===d[i])}const Q=(n,d)=>{const a=Object.assign(Object.assign({},d),{frontEndStack:"react"}),i=!H(w.options,a);(n!==w.publicKey||i)&&(w.publicKey=n,w.options=a,w.instanceMercadoPago=void 0)};var ee=function(n,d,a,i){function f(s){return s instanceof a?s:new a(function(t){t(s)})}return new(a||(a=Promise))(function(s,t){function c(e){try{o(i.next(e))}catch(r){t(r)}}function u(e){try{o(i.throw(e))}catch(r){t(r)}}function o(e){e.done?s(e.value):f(e.value).then(c,u)}o((i=i.apply(n,d||[])).next())})};const ne=()=>ee(void 0,void 0,void 0,function*(){}),L=()=>{},U=n=>{console.error(n)},te=n=>{console.log(n)},oe=()=>{console.log("onClickEditShippingData default implementation")},ae=()=>{console.log("onClickEditShippingData default implementation")},ce=n=>{console.log(n)},re=n=>{console.log(n)};var ie=function(n,d,a,i){function f(s){return s instanceof a?s:new a(function(t){t(s)})}return new(a||(a=Promise))(function(s,t){function c(e){try{o(i.next(e))}catch(r){t(r)}}function u(e){try{o(i.throw(e))}catch(r){t(r)}}function o(e){e.done?s(e.value):f(e.value).then(c,u)}o((i=i.apply(n,d||[])).next())})};const A=({settings:n,name:d,containerId:a,controller:i})=>ie(void 0,void 0,void 0,function*(){const f=yield w.getInstance(),s=f?.bricks();window[i]=yield s?.create(d,a,n)}),$=200,se=({onReady:n=L,onError:d=U,onSubmit:a=ne,onBinChange:i=te,onClickEditShippingData:f=oe,onClickEditBillingData:s=ae,onRenderNextStep:t=ce,onRenderPreviousStep:c=re,initialization:u,customization:o,locale:e,id:r="paymentBrick_container"})=>(m.useEffect(()=>{const p={settings:{initialization:u,customization:o,locale:e,callbacks:{onReady:n,onError:d,onSubmit:a,onBinChange:i,onClickEditShippingData:f,onClickEditBillingData:s,onRenderNextStep:t,onRenderPreviousStep:c}},name:"payment",containerId:r,controller:"paymentBrickController"},x=setTimeout(()=>{A(p)},$);return()=>{var h;clearTimeout(x),(h=window.paymentBrickController)===null||h===void 0||h.unmount()}},[u,o,n,d,a,i]),B.createElement("div",{id:r})),le=({onReady:n=L,onError:d=U,customization:a,initialization:i,locale:f,id:s="statusScreenBrick_container"})=>(m.useEffect(()=>{const t={settings:{initialization:i,customization:a,locale:f,callbacks:{onReady:n,onError:d}},name:"statusScreen",containerId:s,controller:"statusScreenBrickController"},c=setTimeout(()=>{A(t)},$);return()=>{var u;clearTimeout(c),(u=window.statusScreenBrickController)===null||u===void 0||u.unmount()}},[i,a,n,d]),B.createElement("div",{id:s}));Q("TEST-d87cb64c-7f9b-4994-8f83-fe7e93c4a5f9",{locale:"es-PE"});const de=({amount:n,payer:d,description:a,externalReference:i,statementDescriptor:f})=>{const[s,t]=m.useState(!1),c=m.useMemo(()=>({amount:n,payer:{email:d.email}}),[n,d]),u=m.useMemo(()=>({paymentMethods:{ticket:"all",bankTransfer:"all",creditCard:"all",debitCard:"all",mercadoPago:"all",maxInstallments:1}}),[]),o=m.useCallback(async({selectedPaymentMethod:p,formData:x})=>{console.log("Payment Brick onSubmit:",{selectedPaymentMethod:p,formData:x});try{const h={...x,description:a||"Payment",installments:1,external_reference:i,statement_descriptor:f};console.log("Sending payment data:",h);const y=await(await fetch("/api/process-payment",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(h)})).json();if(console.log("Payment processing result:",y),y.id){if(v.value=y.id,_.value=y.status,y.status==="approved"){console.log("Payment approved - creating order UUID");const{createOrder:E,submitOrderToBackend:G}=await T(async()=>{const{createOrder:q,submitOrderToBackend:z}=await import("./checkoutStore.BjY-Dy3Q.js").then(K=>K.l);return{createOrder:q,submitOrderToBackend:z}},__vite__mapDeps([0,1])),M=E();console.log("Order UUID created:",M),await G(M)}y.three_ds_info&&(console.log("3DS authentication required",y.three_ds_info),g.value=y.three_ds_info),C.value="status"}else console.error("Payment failed:",y)}catch(h){console.error("Error processing payment:",h)}},[a,i]),e=m.useCallback(async p=>{console.error("Payment Brick Error:",p)},[]),r=m.useCallback(async()=>{console.log("Payment Brick Ready"),t(!0)},[]);return m.useEffect(()=>()=>{console.log("Unmounting Payment Brick"),window.paymentBrickController&&window.paymentBrickController.unmount()},[]),l.jsx("div",{className:"relative min-h-[700px] w-full",children:l.jsx(se,{initialization:c,customization:u,onSubmit:o,onReady:r,onError:e})})},ue=()=>{const[n,d]=m.useState(!1),a=m.useMemo(()=>{const t=g.value;let c;return t&&t.external_resource_url&&(c={externalResourceURL:t.external_resource_url,creq:t.creq||void 0}),console.log("StatusScreen initialization:",{paymentId:String(v.value),hasThreeDS:!!t,additionalInfo:c}),{paymentId:String(v.value),additionalInfo:c}},[g.value,v.value]),i=m.useMemo(()=>{if(g.value){console.log("Skipping customization for 3DS flow");return}const t=P.value||"",c=_.value;console.log("StatusScreen configuration:",{uuid:t,status:c});let u=`${window.location.origin}/checkout`;return c==="approved"&&t?u=`${window.location.origin}/order/${t}/confirmation-success`:(c==="pending"||c==="rejected")&&(u=`${window.location.origin}/checkout`),console.log("Return URL:",u),{backUrls:{error:`${window.location.origin}/checkout`,return:u},visual:{showExternalReference:!0,texts:{ctaGeneralErrorLabel:"Elegir otro medio de pago",ctaCardErrorLabel:"Reintentar pago",ctaReturnLabel:c==="approved"?"Continuar":"Volver"}}}},[P.value,_.value,g.value]),f=m.useCallback(async()=>{console.log("StatusScreen Brick Ready"),d(!0)},[]),s=m.useCallback(async t=>{console.error("StatusScreen Brick Error:",t)},[]);return m.useCallback(()=>{V()},[]),m.useEffect(()=>{if(!n||!v.value)return;const t=_.value;if(console.log("Current payment status:",t),t!=="pending")return;console.log("Payment is pending - starting status polling");let c=0;const u=30,o=setInterval(async()=>{c++,console.log(`Polling payment status (attempt ${c}/${u})`);try{const r=await(await fetch(`/api/payment-status/${v.value}`)).json();if(console.log("Poll result:",r),r.status!=="pending"){if(console.log("Payment status changed to:",r.status),_.value=r.status,g.value=null,r.status==="approved"){console.log("Payment approved - creating order UUID");const{createOrder:p,submitOrderToBackend:x}=await T(async()=>{const{createOrder:I,submitOrderToBackend:y}=await import("./checkoutStore.BjY-Dy3Q.js").then(E=>E.l);return{createOrder:I,submitOrderToBackend:y}},__vite__mapDeps([0,1])),h=p();console.log("Order UUID created:",h),await x(h)}clearInterval(o)}else c>=u&&(console.log("Max polling attempts reached"),clearInterval(o))}catch(e){console.error("Error polling payment status:",e),clearInterval(o)}},1e3);return()=>{clearInterval(o)}},[n,v.value,_.value]),m.useEffect(()=>()=>{console.log("Unmounting Status Screen Brick"),window.statusScreenBrickController&&window.statusScreenBrickController.unmount()},[]),l.jsx("div",{className:"relative min-h-[600px] w-full",children:l.jsx(le,{initialization:a,customization:i,onReady:f,onError:s},`${v.value}-${g.value?"3ds":"std"}`)})},fe=({amount:n,payer:d,description:a,externalReference:i,statementDescriptor:f})=>(O(),l.jsxs("div",{className:"w-full",children:[l.jsx("div",{className:"min-h-[850px] overflow-hidden rounded-lg bg-white shadow-lg",children:C.value==="payment"?l.jsx(l.Fragment,{children:l.jsxs("div",{className:"p-4 md:p-6",children:[l.jsxs("div",{className:"mb-4 flex flex-col gap-3 border-b border-gray-200 pb-3 md:mb-6 md:flex-row md:items-center md:justify-between md:gap-0 md:pb-4",children:[l.jsxs("div",{className:"flex-1",children:[l.jsx("h1",{className:"text-xl font-bold text-gray-900 md:text-2xl",children:"Checkout Seguro"}),l.jsx("p",{className:"mt-1 text-xs text-gray-500 md:text-sm",children:"Completa tu pago de forma segura."}),l.jsxs("div",{className:"mt-2 flex items-baseline gap-2 md:mt-3",children:[l.jsx("span",{className:"text-xs text-gray-500 md:text-sm",children:"Total a pagar:"}),l.jsxs("span",{className:"text-lg font-bold text-blue-600 md:text-xl",children:["S/ ",n.toFixed(2)]})]})]}),l.jsxs("div",{className:"flex items-center gap-2 self-start md:self-auto",children:[l.jsx("svg",{className:"h-5 w-5 text-green-600 md:h-6 md:w-6",fill:"currentColor",viewBox:"0 0 20 20",children:l.jsx("path",{fillRule:"evenodd",d:"M2.166 4.999A11.954 11.954 0 0010 1.944 11.954 11.954 0 0017.834 5c.11.65.166 1.32.166 2.001 0 5.225-3.34 9.67-8 11.317C5.34 16.67 2 12.225 2 7c0-.682.057-1.35.166-2.001zm11.541 3.708a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z",clipRule:"evenodd"})}),l.jsx("span",{className:"text-xs font-medium text-gray-700 md:text-sm",children:"Conexión segura"})]})]}),l.jsx("div",{className:"mt-4 md:mt-6",children:l.jsx(de,{amount:n,payer:d,description:a,externalReference:i,statementDescriptor:f})})]})}):l.jsx("div",{className:"flex h-full w-full flex-col items-center justify-center p-4 pt-8 md:p-6",children:l.jsx(ue,{})})}),l.jsx("div",{className:"mt-3 text-center md:mt-4",children:l.jsx("p",{className:"text-xs text-gray-400 md:text-sm",children:"Protegido por Mercado Pago • Todos los datos están encriptados"})})]})),he=()=>(O(),m.useEffect(()=>(k.value?document.body.style.overflow="hidden":document.body.style.overflow="unset",()=>{document.body.style.overflow="unset"}),[k.value]),k.value?l.jsxs("div",{className:"fixed inset-0 z-50 flex items-center justify-center",children:[l.jsx("div",{className:"absolute inset-0 bg-black/50 backdrop-blur-sm",onClick:N}),l.jsxs("div",{className:"relative z-10 max-h-[90vh] w-full max-w-2xl overflow-y-auto rounded-lg bg-white shadow-2xl",children:[l.jsx("button",{onClick:N,className:"absolute top-4 right-4 z-20 flex h-8 w-8 items-center justify-center rounded-full bg-gray-100 text-gray-600 transition-colors hover:bg-gray-200","aria-label":"Cerrar",children:l.jsx("svg",{className:"h-5 w-5",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:l.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})}),l.jsx("div",{className:"p-6",children:l.jsx(fe,{amount:F.value,payer:{email:j.value.email},description:`Pedido de ${j.value.firstName} ${j.value.lastName}`,externalReference:`${Date.now()}`,statementDescriptor:"CRAZZULA"})})]})]}):null);export{he as default};
